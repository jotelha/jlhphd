# technical settings

variable mpiio                   index  1 # parallel io on or off
variable is_restart              index  0 # marks current run as restart
variable pbc2d                   index  0 # 0: 3d periodic, 1: 2d periodic
variable has_indenter            index  0
variable reinitialize_velocities index  0
variable surfactant_name         index  SDS # SDS or CTAB

# system settings

variable nvtEqSteps     index  100000    # 200 ps
variable nptEqSteps     index  100000    # 200 ps

variable temperatureT   index    298    # K
variable pressureP      index      1    # atm

# the standard TIP3P water model requires not only hydrogen bonds to be rigid,
# but also the HOH angle. Here we set the ID of this angle.
# Look it up within the data file.
variable angleIdWater   index     11

print "Variables in lmp_header.input:"
info variables

# Intialization
if "${is_restart} == 0 && ${pbc2d} > 0" then "boundary p p f"

if "${is_restart} == 0" then "units real"
# http://lammps.sandia.gov/doc/units.html
    #mass = grams/mole
    #distance = Angstroms
    #time = femtoseconds
    #energy = Kcal/mole
    #velocity = Angstroms/femtosecond
    #force = Kcal/mole-Angstrom, compared to gmx: kJ mol^-1 nm^-1,
        # conversion F_lmp = F_gmx * 0.1 [nm/Ang] / 4.184 [kJ/kcal] ~ gmx / 41.81
        # 1000 kJ / (mol*nm) ~ 25 kCal/(mol*Ang)
    #torque = Kcal/mole
    #temperature = Kelvin
    #pressure = atmospheres, 1 atm = 1013 hPa ~ 100 kPa
    #dynamic viscosity = Poise
    #charge = multiple of electron charge (1.0 is a proton)
    #dipole = charge*Angstroms
    #electric field = volts/Angstrom
    #density = gram/cm^dim

# neigh 2.0 bin
# The style value selects what algorithm is used to build the list. The bin
# style creates the list by binning which is an operation that scales linearly
# with N/P, the number of atoms per processor where N = total number of atoms
# and P = number of processors. It is almost always faster than the nsq style
# which scales as (N/P)^2. For unsolvated small molecules in a non-periodic
# box, the nsq choice can sometimes be faster. Either style should give the
# same answers.
# Defaults: 2.0 bin for units = real or metal, skin = 2.0 Angstroms

neigh_modify    delay 2 every 1 check yes
# This command sets parameters that affect the building and use of pairwise
# neighbor lists. Depending on what pair interactions and other commands
# are defined, a simulation may require one or more neighbor lists.

# Note on possible error:
# Out of range atoms - cannot compute PPPM
#    One or more atoms are attempting to map their charge to a PPPM grid point
#    that is not owned by a processor. This is likely for one of two reasons,
#    both of them bad. First, it may mean that an atom near the boundary of a
#    processor’s sub-domain has moved more than 1/2 the neighbor skin distance
#    without neighbor lists being rebuilt and atoms being migrated to new
#    processors. This also means you may be missing pairwise interactions that
#    need to be computed. The solution is to change the re-neighboring criteria
#    via the neigh_modify command. The safest settings are “delay 0 every 1
#    check yes”. Second, it may mean that an atom has moved far outside a
#    processor’s sub-domain or even the entire simulation box. This indicates
#    bad physics, e.g. due to highly overlapping atoms, too large a timestep,
#    etc.

if "${is_restart} == 0" then "atom_style      full"
if "${is_restart} == 0" then "bond_style      harmonic"

if "${is_restart} == 0" then "angle_style     charmm"
# Source: http://lammps.sandia.gov/doc/angle_charmm.html
# angle potential E = K * ( theta - theta_0)^2 + K_UB * ( r - r_UB )^2

if "${is_restart} == 0" then "dihedral_style  charmmfsw"
# Source: http://lammps.sandia.gov/doc/dihedral_charmm.html
# dihedral potential E = K * [ 1 + cos( n*phi - d ) ]
#
# (MacKerell) MacKerell, Bashford, Bellott, Dunbrack, Evanseck, Field, Fischer,
#             Gao, Guo, Ha, et al, J Phys Chem B, 102, 3586 (1998).

if "${is_restart} == 0" then "improper_style  harmonic"
if "${is_restart} == 0" then "pair_style      lj/charmmfsw/coul/long 8 12"
# Quote from http://lammps.sandia.gov/doc/pair_charmm.html
# The newer styles with charmmfsw or charmmfsh in their name replace the
# energy switching with force switching (fsw) and force shifting (fsh)
# functions, for LJ and Coulombic interactions respectively. These follow the
# formulas and description given in (Steinbach) and (Brooks) to minimize these
# artifacts.
#
# (Steinbach) Steinbach, Brooks, J Comput Chem, 15, 667 (1994).
# (Brooks)    Brooks, et al, J Comput Chem, 30, 1545 (2009).

# #
# Storm, S., Jakobtorweihen, S., Smirnova, I., Panagiotopoulos, A.Z., 2013.
# Molecular dynamics simulation of SDS and CTAB micellization and prediction
# of partition equilibria with COSMOmic. Langmuir 29, 11582-11592.
#
# recommend an 8 Ang inner cutoff:
#
# "Recently, Piggot el al. compared different force fields for lipids. Although
# "their recommendations for CHARMM36 force field (CHARMM TIP3P water model,
# "0.8 nm Lennard-Jones switching) are based on bilayer simulations, they were
# "followed here
#
# #
# http://www.gromacs.org/Documentation/Terminology/Force_Fields/CHARMM
#
# notes
#
# Please also note that the switching distance is a matter of some debate in
# lipid bilayer simulations, and it is dependent to some extent on the nature
# of the lipid. Some studies have found that an 0.8-1.0 nm switch is
# appropriate, others argue 0.8-1.2 nm is best, and yet others stand by
# 1.0-1.2 nm. The user is cautioned to thoroughly investigate the force field
# literature for their chosen lipid(s) before beginning a simulation!
#

if "${is_restart} == 0" then "pair_modify     mix arithmetic"
# kspace_style    pppm 1e-6
kspace_style    pppm 1e-4
# Quote from http://lammps.sandia.gov/doc/kspace_style.html:
# pppm value = accuracy
#  accuracy = desired relative error in forces
#
# The pppm style invokes a particle-particle particle-mesh solver (Hockney)
# which maps atom charge to a 3d mesh, uses 3d FFTs to solve Poisson’s
# equation on the mesh, then interpolates electric fields on the mesh points
# back to the atoms. It is closely related to the particle-mesh Ewald
# technique (PME) (Darden) used in AMBER and CHARMM. The cost of traditional
# Ewald summation scales as N^(3/2) where N is the number of atoms in the
# system. The PPPM solver scales as Nlog(N) due to the FFTs, so it is almost
# always a faster choice (Pollock).
#
# [...]
#
# The specified accuracy determines the relative RMS error in per-atom forces
# calculated by the long-range solver. It is set as a dimensionless number,
# relative to the force that two unit point charges (e.g. 2 monovalent ions)
# exert on each other at a distance of 1 Angstrom. This reference value was
# chosen as representative of the magnitude of electrostatic forces in atomic
#  systems. Thus an accuracy value of 1.0e-4 means that the RMS error will be
#  a factor of 10000 smaller than the reference force.
#
# The accuracy setting is used in conjunction with the pairwise cutoff to
# determine the number of K-space vectors for style ewald or the grid size for
#  style pppm or msm.
#
# (Hockney)   Hockney and Eastwood, Computer Simulation Using Particles,
#             Adam Hilger, NY (1989).
# (Darden)    Darden, York, Pedersen, J Chem Phys, 98, 10089 (1993).
# (Pollock)   Pollock and Glosli, Comp Phys Comm, 95, 93 (1996).

if "${pbc2d} > 0" then &
    "kspace_modify slab 3.0"
# The slab keyword allows an Ewald or PPPM solver to be used for a systems that
# are periodic in x,y but non-periodic in z - a boundary setting of
# “boundary p p f”. This is done by treating the system as if it were periodic
# in z, but inserting empty volume between atom slabs and removing dipole
# inter-slab interactions so that slab-slab interactions are effectively turned
# off. The volfactor value sets the ratio of the extended dimension in z divided
# by the actual dimension in z. The recommended value is 3.0. A larger value is
# inefficient; a smaller value introduces unwanted slab-slab interactions. The
# use of fixed boundaries in z means that the user must prevent particle
# migration beyond the initial z-bounds, typically by providing a wall-style
# fix. The methodology behind the slab option is explained in the paper by
# (Yeh). The slab option is also extended to non-neutral systems (Ballenegger).
#
# An alternative slab option can be invoked with the nozforce keyword in lieu of
# the volfactor. This turns off all kspace forces in the z direction. The
# nozforce option is not supported by MSM. For MSM, any combination of periodic,
# non-periodic, or shrink-wrapped boundaries can be set using boundary (the slab
# approximation in not needed). The slab keyword is not currently supported by
# Ewald or PPPM when using a triclinic simulation cell. The slab correction has
# also been extended to point dipole interactions (Klapp) in kspace_style
# ewald/disp.

# If you wish to apply an electric field in the Z-direction, in conjunction with
# the slab keyword, you should do it by adding explicit charged particles to the
# +/- Z surfaces. If you do it via the fix efield command, it will not give the
# correct dielectric constant due to the Yeh/Berkowitz (Yeh) correction not
# being compatible with how fix efield works.

if "${is_restart} == 0" then "read_data       ${dataFile}"

# determine center
variable z_center equal $(( zlo + zhi ) / 2.0)
# For style plane, a plane is defined which contain the point (px,py,pz) and
# has a normal vector (nx,ny,nz). The normal vector does not have to be of unit
# length. The “inside” of the plane is the half-space in the direction of the
# normal vector; see the discussion of the side option below.
region upper_half plane 0 0 ${z_center} 0 0 1 side in

if "${is_restart} == 0" then "special_bonds   charmm"
# http://lammps.sandia.gov/doc/special_bonds.html
# The charmm keyword sets the 3 coefficients to 0.0, 0.0, 0.0 for both LJ and
# Coulombic interactions, which is the default for a commonly used version of
# the CHARMM force field. Note that in pair styles lj/charmm/coul/charmm and
# lj/charmm/coul/long the 1-4 coefficients are defined explicitly, and these
# pairwise contributions are computed as part of the charmm dihedral style
# - see the pair_coeff and dihedral_style commands for more information.
# See (MacKerell) for a description of the CHARMM force field.

if "${is_restart} == 0" then "timestep       2.0 # 0.002 ps = 2 fs"

if "${is_restart} == 0 && ${surfactant_name} == SDS" then &
  "group          solvent    type  8 9    #  8 - H, 10 - O" &
  "group          solid      type  11     # 11 - Au" &
  "group          ion        type  10     # 10 - Na+" &
  "group          surfactant subtract all solvent solid ion" &
  "group          nonwater   subtract all solvent" &
elif "${is_restart} == 0 && ${surfactant_name} == CTAB" then &
  "group          solvent    type  8 9    #  8 - H, 10 - O" &
  "group          solid      type  11     # 11 - Au" &
  "group          ion        type  10     # 10 - Br-" &
  "group          surfactant subtract all solvent solid ion" &
  "group          nonwater   subtract all solvent"

# correct if indenter is present
if "${is_restart} == 0 && ${has_indenter} > 0" then &
  "group          atoms_in_upper_half region upper_half" &
  "group          substrate  subtract solid atoms_in_upper_half" &
  "group          indenter   subtract solid substrate" &
elif "${is_restart} == 0" then &
  "group          substrate intersect all solid"


# for compatibility reasons:
if "${is_restart} == 0" then &
    "group    surface     intersect all substrate" &
    "group    water       intersect all solvent" &
    "group    nonindenter subtract all indenter" &
    "group    nonsolvent  subtract all solvent"

# SDS - specific
#       1      1.008  # HAL2
#       2      1.008  # HAL3
#       3     12.011  # CTL2
#       4     12.011  # CTL3
#       5    15.9994  # OSL
#       6    15.9994  # O2L
#       7      32.06  # SL
#       8      1.008  # HT
#       9    15.9994  # OT
#      10   22.98977  # SOD
#      11   196.9665  # AU

# CTAB - specific
#
# group          water      type  8 9    #  8 - H, 10 - O
# group          surface    type  11     # 11 - Au
# group          ion        type  10     # 10 - Br-
# group          surfactant subtract all water surface ion
# group          nonwater   subtract all water
#
# From "41_CTAB_on_AU_111_21x12x2_bilayer_psfgen.data"
#        1      1.008  # HL
#        2      1.008  # HAL2
#        3      1.008  # HAL3
#        4     12.011  # CTL2
#        5     12.011  # CTL3
#        6     12.011  # CTL5
#        7     14.007  # NTL
#        8      1.008  # HT
#        9    15.9994  # OT
#       10     79.904  # BR
#       11   196.9665  # AU

# exclude intra-indenter interactions for rigid indenter
if "${has_indenter} > 0 " then &
  "neigh_modify exclude group indenter indenter check no"

# walls if box non-periodic, use AU paramters (sigma ignored)
if "${pbc2d} > 0" then &
  "fix upper_wall all wall/harmonic zhi EDGE 5.29 2.629 3.0" &
  "fix_modify upper_wall energy yes virial yes"
#                     ^style        ^face
#                                       ^coord
#                                            ^epsilon
#                                                 ^sigma
#                                                       ^cutoff
# https://lammps.sandia.gov/doc/fix_wall.html
# args = coord epsilon sigma cutoff
#  coord = position of wall = EDGE or constant or variable
#    EDGE = current lo or hi edge of simulation box
#    constant = number like 0.0 or -30.0 (distance units)
#    variable = equal-style variable like v_x or v_wiggle
# epsilon = strength factor for wall-particle interaction (energy or energy/distance^2 units)
#    epsilon can be a variable (see below)
# sigma = size factor for wall-particle interaction (distance units)
#    sigma can be a variable (see below)
# cutoff = distance from wall at which wall-particle interaction is cut off (distance units)
#
# The harmonic style is a softer potential and does not blow up as r -> 0, but
# you must use a large enough epsilon that particles always reamin on the
# correct side of the wall (r > 0).
#
# The forces due to this fix are imposed during an energy minimization, invoked
# by the minimize command.
#
# If you want the atom/wall interaction energy to be included in the total
# potential energy of the system (the quantity being minimized), you MUST enable
# the fix_modify energy option for this fix.
#
# No information about this fix is written to binary restart files.
#
# The fix_modify energy option is supported by this fix to add the energy of
# interaction between atoms and each wall to the system’s potential energy as
# part of thermodynamic output.
#
# The fix_modify virial option is supported by this fix to add the contribution
# due to the interaction between atoms and each wall to the system’s virial as
# part of thermodynamic output. The default is virial no

# fix thermoAveOut all ave/time 1 100 100 c_thermo_etotal c_thermo_ke c_thermo_pe &
#   c_thermo_temp c_thermo_press c_thermo_enthalpy c_thermo_ebond c_thermo_eangle &
#   c_thermo_edihed c_thermo_eimp c_thermo_epair c_thermo_evdwl c_thermo_ecoul  &
#   c_thermo_elong c_thermo_etail c_thermo_vol &
#   mode scalar file ${baseName}_thermo.out
thermo_style   custom step etotal ke pe temp press enthalpy ebond eangle &
  edihed eimp epair evdwl ecoul elong etail vol
# log output every 2 ps
thermo         1000
thermo_modify  norm no
# Note that some computes calculate “intensive” global quantities like
# temperature; others calculate “extensive” global quantities like kinetic
# energy that are summed over all atoms in the compute group. Intensive
# quantities are printed directly without normalization by thermo_style custom.
# Extensive quantities may be normalized by the total number of atoms in the
# simulation (NOT the number of atoms in the compute group) when output,
# depending on the thermo_modify norm option being used.
