name: "JUWELS LAMMPS post-processing"
spec:
  _category: "juwels_noqueue"
  _allow_fizzled_parents: True
  _files_in:
    # data_file:       default.lammps # only passed, if run complete
    traj_file:       default.nc
    log_file:        log.lammps
    ave_file:        thermo_ave.out
    joint_traj_file:       previous.nc # from previous post-processing task
    joint_thermo_file:     previous.thermo.out
    joint_ave_file:        previous.thermo_ave.out

  _files_out:
    joint_traj_file:       default.nc
    joint_thermo_file:     thermo.out
    joint_ave_file:        thermo_ave.out

  _tasks:

  - _fw_name: FileTransferTask
    dest: .
    files:
    - /default.nc
    - /log.lammps
    - /thermo_ave.out
    mode: copy

  - _fw_name: CmdTask
    cmd: extract_thermo.sh # extracts thermo output from lammps log
    opt:
    - log.lammps # input file
    - thermo.out # output file
    stderr_file:   extract_thermo.err
    stdout_file:   extract_thermo.out
    fizzle_bad_rc: false
    use_shell:     true

  - _fw_name: CmdTask # concatenate previous and current thermo output
    cmd: join_thermo.py
    opt:
    - -v # verbose info
    - previous.thermo.out # 1st input file
    - thermo.out  # 2nd input file
    - joint.thermo.out # output file
    stderr_file:   join_thermo.err
    stdout_file:   join_thermo.out
    fizzle_bad_rc: false
    use_shell:     true

  - _fw_name: CmdTask # concatenate previous and current thermo ave output
    cmd: join_thermo.py
    opt:
    - -v # verbose info
    - --hashed-header
    - previous.thermo_ave.out # 1st input file
    - thermo_ave.out  # 2nd input file
    - joint.thermo_ave.out # output file
    stderr_file:   join_thermo_ave.err
    stdout_file:   join_thermo_ave.out
    fizzle_bad_rc: false
    use_shell:     true

  - _fw_name: CmdTask # concatenate previous and current trajectory
    cmd: ncjoin.py
    opt:
    - -v time
    - -n joint.nc # output file
    - previous.nc # 1st input file
    - default.nc  # 2nd input file
    stderr_file:   ncjoin.err
    stdout_file:   ncjoin.out
    fizzle_bad_rc: false
    use_shell:     true

  # if no previous files provided via _files_in, just forward current files
  # by letting the following file copy task fail deliberately
  - _fw_name: FileTransferTask
    mode: copy
    ignore_errors: true
    files:
    - src:  joint.thermo.out
      dest: thermo.out
    - src:  joint.thermo_ave.out
      dest: thermo_ave.out
    - src:  joint.nc
      dest: default.nc
