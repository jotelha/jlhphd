{% extends "fw_base.yaml" %}
{% block body %}
name: "{{ machine|default("NEMO",true) }}, {{ title }}, AFM probe insetion"
spec:
  _category: {{ worker|default("nemo_noqueue",true) }}
  _queueadapter:
    {{ render_queueadapter()|safe|indent(4) }}

  _files_in:
    indenter_file:  indenter.lammps
    interface_file: interface.lammps
  _files_out:
    lmp_file:  system.lammps
    pdb_file:  system.pdb
    psf_file:  system.psf
    png_file:  system.png
  _tasks:

  - _fw_name: CmdTask
    cmd: strip_comments.py
    opt:
    - interface.lammps
    - interface_stripped.lammps
    stderr_file: strip_comments.err
    stdout_file: strip_comments.out
    use_shell: true
    fizzle_bad_rc: true

  - _fw_name: CmdTask
    cmd: extract_bb.py
    opt:
    - interface_stripped.lammps
    - bb.yaml
    stderr_file: extract_bb.err
    stdout_file: extract_bb.out
    use_shell: true
    fizzle_bad_rc: true

  - _fw_name: ScriptTask
    script: |
      echo "package require jlhvmd"
      echo "jlh set distance {{ sb_in_dist }} indenterInfile indenter.lammps interfaceInfile interface.lammps outputPrefix system"
      echo "jlh use {{ surfactant }}"
      echo "jlh read bb bb.yaml"
      echo "jlh insert"
    stdout_file: in.tcl
    stderr_file: in.tcl.err
    use_shell: true
    fizzle_bad_rc: true

  - _fw_name: CmdTask
    cmd: vmd
    opt: -eofexit -e in.tcl
    stderr_file: vmd.err
    stdout_file: vmd.out
    use_shell: true
    fizzle_bad_rc: true

  - _fw_name: CmdTask
    cmd: convert
    opt:
    - system.tga
    - system.png
    stderr_file: convert.err
    stdout_file: convert.out
    use_shell: true
    fizzle_bad_rc: true

  metadata:
    state: indenter insertion
    {{ render_metadata()|indent(4)}}
{% endblock %}
