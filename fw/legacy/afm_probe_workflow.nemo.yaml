name: "AFM probe approach, 646 SDS on AU 111, preassembled bilayer, 50 Ang rescaled AFM probe"
fws:
- fw_id: -2
  name: AFM probe insertion
  spec:
    _category: bwcloud_std
    _files_out:
      data_file: system.lammps
      pdb_file:  system.pdb
      psf_file:  system.psf
    _tasks:
    
    - _fw_name: GetFilesTask
      identifiers:
      - 50Ang_stepped.pdb
      - 646_SDS_on_AU_111_51x30x2_bilayer_with_counterion_10ns.lammps
      new_file_names:
      - indenter.pdb
      - interface.lammps
      
    - _fw_name: GetFilesTask
      identifiers:
      - jlh_vmd.tcl
      - indenter_insertion.tcl
      new_file_names:
      - jlh_vmd.tcl
      - indenter_insertion.template
    
    - _fw_name: TemplateWriterTask
      context:
        desired_distance: 75.0 # in Angstrom
        indenter_file: indenter.pdb
        interface_file: interface.lammps
        output_prefix: system
        surfactant: SDS
      output_file: indenter_insertion.tcl
      template_file: indenter_insertion.template
    
    - _fw_name: CmdTask
      fizzle_bad_rc: true
      cmd: vmd
      opt: -eofexit -e indenter_insertion.tcl
      stderr_file: std.err
      stdout_file: std.out
      use_shell: true
    
    - _fw_name: CmdTask
      fizzle_bad_rc: false
      cmd: convert
      opt: system.tga system.png
      use_shell: true
    step: afm_probe_insertion

- fw_id: -3
  name: Merge AFM system coordinates and parameters
  spec:
    _category: bwcloud_std
    _files_in:
      data_file: datafile.lammps
    _files_out:
      data_file: initial.lammps
    _tasks:
    
    - _fw_name: GetFilesTask
      identifiers:
      - 646_SDS_on_AU_111_51x30x2_bilayer_with_counterion_psfgen.data
      new_file_names:
      - reffile.lammps
    
    - _fw_name: GetFilesTask
      identifiers:
      - MergeLammpsDataFiles.py
      - merge.py
      new_file_names:
      - MergeLammpsDataFiles.py
      - merge.py
    
    - _fw_name: CmdTask
      fizzle_bad_rc: true
      cmd: pizza.py
      opt:
      - -f merge.py
      - datafile.lammps
      - reffile.lammps
      - initial.lammps
      stderr_file: std.err
      stdout_file: std.out
      use_shell: true
    
    - _fw_name: DeleteFilesTask
      identifiers:
      - 646_SDS_on_AU_111_51x30x2_bilayer_with_counterion_50Ang_stepped_initial.lammps
    
    - _fw_name: AddFilesTask
      identifiers:
      - 646_SDS_on_AU_111_51x30x2_bilayer_with_counterion_50Ang_stepped_initial.lammps
      paths:
      - initial.lammps
      metadata:
        - system_name:      646_SDS_on_AU_111_51x30x2_bilayer_with_counterion_50Ang_stepped
          surfactant:       SDS
          sf_nmolecules:    646
          sf_preassembly:   bilayer
          counterion:       NA
          ci_preassembly:   at polar heads
          substrate:        AU
          sb_name:          AU_111_51x30x2
          sb_crystal_plane: 111
          sb_multiples:
          - 51
          - 30
          - 2
          solvent:          H2O
          sv_density:       997 # kg m^-3
          sv_preassembly:   random
          indenter:         AU
          indenter_pdb:     50Ang_stepped
          indenter_dist:    7.5 # nm, initial distance above substrate
          temperature:      298 # K
          pressure:         1 # atm
          step:             probe inserted
    step: pizzapy_merge
    
# change filesystem
- fw_id: -4
  name: NEMO LAMMPS minimization
  spec:
    _category: nemo_queue
    _files_out:
      data_file: default.lammps
      log_file:  log.lammps
    _queueadapter:
      nodes: 2
      ppn: 20
      queue: ''
      walltime: 08:00:00
    _tasks:
      
    - _fw_name: GetFilesTask
      identifiers:
      - lmp_header.input
      - lmp_minimization.input
      - 646_SDS_on_AU_111_51x30x2_bilayer_with_counterion_50Ang_stepped_initial.lammps
      new_file_names:
      - lmp_header.input
      - lmp_minimization.input
      - datafile.lammps
      
    - _fw_name: CmdTask
      fizzle_bad_rc: true
      cmd: lmp
      opt:
      - -in lmp_minimization.input
      - -v surfactant_name SDS
      - -v has_indenter 1
      - -v mpiio 0
      - -v robust_minimization 0
      - -v pbc2d 0
      - -v compute_interactions 0
      - -v store_forces 0
      - -v freeze_substrate 1
      stderr_file: std.err
      stdout_file: std.out
      use_shell: true
    _trackers:
    - filename: log.lammps
      nlines: 25
    step: minimization

- fw_id: -5
  name: NEMO LAMMPS equilibration NVT
  spec:
    _category: nemo_queue
    _files_in:
      data_file: datafile.lammps
    _files_out:
      data_file: default.lammps
      traj_file: default.nc
      log_file:  log.lammps
    _queueadapter:
      nodes: 2
      ppn: 20
      queue: ''
      walltime: 24:00:00
    _tasks:
    
    - _fw_name: GetFilesTask
      identifiers:
      - lmp_header.input
      - lmp_equilibration_nvt.input
    
    - _fw_name: CmdTask
      cmd: lmp
      opt:
      - -in lmp_equilibration_nvt.input
      - -v surfactant_name SDS
      - -v has_indenter 1
      - -v pbd2d 0
      - -v reinitialize_velocities 1
      - -v nvtEqSteps 10000
      - -v compute_interactions 0
      - -v store_forces 0
      - -v mpiio 1
      stderr_file: std.err
      stdout_file: std.out
      use_shell: true
      fizzle_bad_rc: true
    _trackers:
    - filename: log.lammps
      nlines: 25
    step: equilibration_nvt

- fw_id: -6
  name: NEMO LAMMPS post-NVT-equilibration
  spec:
    _category: nemo_noqueue
    _files_in:
      log_file:  log.lammps
    _files_out:
      thermo_file: thermo.out
    _tasks:
    - _fw_name: GetFilesTask
      identifiers:
      - extract_thermo.sh

    - _fw_name: ScriptTask
      script:
      - bash extract_thermo.sh log.lammps thermo.out
      use_shell:     true
      fizzle_bad_rc: false


- fw_id: -7
  name: NEMO LAMMPS equilibration NPT
  spec:
    _category: nemo_queue
    _files_in:
      data_file: datafile.lammps
    _files_out:
      data_file: default.lammps
      traj_file: default.nc
      log_file:  log.lammps
    _queueadapter:
      nodes: 2
      ppn: 20
      queue: ''
      walltime: 24:00:00
    _tasks:
    
    - _fw_name: GetFilesTask
      identifiers:
      - lmp_header.input
      - lmp_equilibration_npt.input
    
    - _fw_name: CmdTask
      cmd: lmp
      opt:
      - -in lmp_equilibration_npt.input
      - -v surfactant_name SDS
      - -v has_indenter 1
      - -v pbd2d 0
      - -v reinitialize_velocities 0
      - -v nptEqSteps 10000
      - -v pbc2d 0
      - -v compute_interactions 0
      - -v store_forces 0
      - -v mpiio 0
      stderr_file: std.err
      stdout_file: std.out
      use_shell: true
      fizzle_bad_rc: true
    _trackers:
    - filename: log.lammps
      nlines: 25
    step: equilibration_npt

- fw_id: -8
  name: NEMO LAMMPS post-NPT-equilibration
  spec:
    _category: nemo_noqueue
    _files_in:
      log_file:  log.lammps
      data_file: datafile.lammps
    _files_out:
      thermo_file: thermo.out
    _tasks:
    - _fw_name: GetFilesTask
      identifiers:
      - extract_thermo.sh

    - _fw_name: ScriptTask
      script:
      - bash extract_thermo.sh log.lammps thermo.out
      use_shell:     true
      fizzle_bad_rc: false

    # first delete if file existent
    - _fw_name: DeleteFilesTask
      identifiers:
      - 646_SDS_on_AU_111_51x30x2_bilayer_with_counterion_50Ang_stepped_nptEquilibrated.lammps

    # then add again:
    - _fw_name: AddFilesTask
      identifiers:
      - 646_SDS_on_AU_111_51x30x2_bilayer_with_counterion_50Ang_stepped_nptEquilibrated.lammps
      paths:
      - datafile.lammps
      metadata:
      - system_name:      646_SDS_on_AU_111_51x30x2_bilayer_with_counterion_50Ang_stepped
        surfactant:       SDS
        sf_nmolecules:    646
        sf_preassembly:   bilayer
        counterion:       NA
        ci_preassembly:   at polar heads
        substrate:        AU
        sb_name:          AU_111_51x30x2
        sb_crystal_plane: 111
        sb_multiples:
        - 51
        - 30
        - 2
        solvent:          H2O
        sv_density:       997 # kg m^-3
        sv_preassembly:   random
        indenter:         AU
        indenter_pdb:     50Ang_stepped
        indenter_dist:    7.5 # nm, initial distance above substrate
        temperature:      298 # K
        pressure:         1 # atm
        state:            npt equilibrated
        
- fw_id: -9
  name: NEMO LAMMPS production run, online
  spec:
    _category: nemo_queue
    _queueadapter:
      nodes: 8
      ppn: 20
      queue: ''
      walltime: 96:00:00
    _files_in:
      data_file:       datafile.lammps
    _files_out:
      data_file:       default.lammps
      traj_file:       default.nc
      log_file:        log.lammps
      ave_file:        thermo_ave.out
    _tasks:
    
    - _fw_name: GetFilesTask
      identifiers:
      - lmp_header.input
      - lmp_production.input
      - lmp_production_mixed.input
    
    - _fw_name: CmdTask
      cmd: lmp
      opt:
      - -in lmp_production.input
      - -v surfactant_name SDS
      - -v has_indenter 1
      - -v constant_indenter_velocity -0.000001
      - -v productionSteps 37500000
      - -v pbc2d 0
      - -v reinitialize_velocities 0
      - -v use_colvars 0
      - -v mpiio 1
      - -v thermo_frequency 10000
      - -v thermo_average_frequency 10000
      - -v netcdf_frequency  100000
      - -v restart_frequency 100000
      - -v compute_interactions 1
      - -v store_forces 1
      stderr_file:   std.err
      stdout_file:   std.out
      fizzle_bad_rc: true
      use_shell:     true
    
    _trackers:
    - filename: log.lammps
      nlines: 25

# Recover most recent restart file:
- fw_id: -10
  name: NEMO recover failed LAMMPS run
  spec:
    _category: nemo_noqueue
    _allow_fizzled_parents: True
    _files_out:
      restart_file: default.mpiio.restart
    _tasks:
    
    - _fw_name: RecoverLammpsTask
      recover:      True # filter most recent restart file and forward
      repeated_recover_fw_name: NEMO recover failed LAMMPS run, repeatedly
      max_restarts: 5 # repeatedly append recover and restart fireworks
      # a firework to be appended as restart if initial LAMMPS run fails
      restart_fw:
        name: NEMO LAMMPS restart run
        spec:
        _category: nemo_queue
        _queueadapter:
          nodes: 8
          ppn: 20
          queue: ''
          walltime: 96:00:00
        _files_in:
          restart_file:    default.mpiio.restart
        _files_out:
          data_file:       default.lammps
          traj_file:       default.nc
          log_file:        lammps.log
          ave_file:        thermo_ave.out
        _tasks:
        
        - _fw_name: GetFilesTask
          identifiers:
          - lmp_header.input
          - lmp_production.input
          - lmp_production_mixed.input
        
        - _fw_name: CmdTask
          cmd: lmp
          opt:
          - -in lmp_production.input
          - -v surfactant_name SDS
          - -v has_indenter 1
          - -v constant_indenter_velocity -0.000001
          - -v productionSteps 37500000
          - -v pbc2d 0
          - -v reinitialize_velocities 0
          - -v use_colvars 0
          - -v mpiio 1
          - -v thermo_frequency 10000
          - -v thermo_average_frequency 10000
          - -v netcdf_frequency 100000
          - -v restart_frequency 100000
          - -v compute_interactions 1
          - -v store_forces 1
          - -v is_restart 1
          - -v restartFile default.mpiio.restart
          stderr_file:   std.err
          stdout_file:   std.out
          fizzle_bad_rc: true
          use_shell:     true
        
        _trackers:
        - filename: log.lammps
          nlines: 25
          
links:
  -2:
  - -3
  -3:
  - -4
  -4:
  - -5
  -5:
  - -6
  - -7
  -7:
  - -8
  - -9
  -9:
  - -10


metadata:
    system_name:      646_SDS_on_AU_111_51x30x2_bilayer_with_counterion_50Ang_stepped
    surfactant:       SDS
    sf_nmolecules:    646
    sf_preassembly:   bilayer
    counterion:       NA
    ci_preassembly:   at polar heads
    substrate:        AU
    sb_name:          AU_111_51x30x2
    sb_crystal_plane: 111
    sb_multiples:
    - 51
    - 30
    - 2
    solvent:          H2O
    sv_density:       997 # kg m^-3
    sv_preassembly:   random
    indenter:         AU
    indenter_pdb:     50Ang_stepped
    indenter_dist:    7.5 # nm, initial distance above substrate
    temperature:      298 # K
    pressure:         1 # atm
    indenter_vel:     0.1 # m / s, constant speed, linear translation
    indenter_dist:    7.5 # nm, initial distance above substrate
    temperature:      298 # K
    pressure:         1 # atm
    total_steps:      37500000 # a 2 fs each
    total_time:       75 # ns