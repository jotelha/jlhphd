name: "LAMMPS Production Run on JUWELS"
fws:
- fw_id: -1
  name: "JUWELS File Retrieval"
  spec:
    _category: "juwels_noqueue"
    _files_out:
      data_file:       datafile.lammps
      input_file_1:    lmp_header.input
      input_file_2:    lmp_production.input
      input_file_3:    lmp_production_mixed.input
    _tasks:
    - _fw_name: GetFilesTask
      identifiers:
      - lmp_header.input
      - lmp_production.input
      - lmp_production_mixed.input
      - 646_SDS_on_AU_111_51x30x2_hemicylinders_with_counterion_50Ang_stepped_nptEquilibrated.lammps
      new_file_names:
      - lmp_header.input
      - lmp_production.input
      - lmp_production_mixed.input
      - datafile.lammps

- fw_id: -2
  name: "JUWELS Production, offline"
  spec:
    _category: "juwels_queue"
    _queueadapter:
      nodes:           2
      ntasks:          192
      ntasks_per_node: 96
      queue:           batch
      walltime:        06:00:00
      account:         hfr13
    _files_in:
      input_file_1:    lmp_header.input
      input_file_2:    lmp_production.input
      input_file_3:    lmp_production_mixed.input
      data_file:       datafile.lammps
    _files_out:
      data_file:       default.lammps
      traj_file:       default.nc
      log_file:        log.lammps
      ave_file:        thermo_ave.out
    _tasks:
    - _fw_name: CmdTask
      cmd: lmp
      opt:
      - -in lmp_production.input
      - -v surfactant_name SDS
      - -v has_indenter 1
      - -v constant_indenter_velocity -0.000001
      - -v productionSteps 37500000
      - -v pbc2d 0
      - -v reinitialize_velocities 0
      - -v use_colvars 0
      - -v mpiio 1
      - -v thermo_frequency 1000
      - -v thermo_average_frequency 1000
      - -v netcdf_frequency  10000
      - -v restart_frequency 10000
      - -v compute_interactions 1
      - -v store_forces 1
      stderr_file:   std.err
      stdout_file:   std.out
      fizzle_bad_rc: true
      use_shell:     true
    _trackers:
    - filename: log.lammps
      nlines: 25

# Recover most recent restart file:
- fw_id: -2
  name: "JUWELS recover failed LAMMPS run"
  spec:
    _category: "juwels_noqueue"
    _allow_fizzled_parents: True
    _files_out:
      restart_file: default.mpiio.restart
    _tasks:
    - _fw_name: RecoverLammpsTask
      recover:      True # filter most recent restart file and forward
      repeated_recover_fw_name: JUWELS recover failed LAMMPS run, repeatedly
      max_restarts: 5 # repeatedly append recover and restart fireworks
      # a firework to be appended as restart if initial LAMMPS run fails
      restart_fw:
        name: "JUWELS LAMMPS restart run"
        spec:
        _category: "juwels_queue"
        _queueadapter:
          nodes:           2
          ntasks:          192
          ntasks_per_node: 96
          queue:           batch
          walltime:        06:00:00
          account:         hfr13
        _files_in:
          restart_file:    default.mpiio.restart
        _files_out:
          data_file:       default.lammps
          traj_file:       default.nc
          log_file:        lammps.log
          ave_file:        thermo_ave.out
        _tasks:
        - _fw_name: GetFilesTask
          identifiers:
          - lmp_header.input
          - lmp_production.input
          - lmp_production_mixed.input
        - _fw_name: CmdTask
          cmd: lmp
          opt:
          - -in lmp_production.input
          - -v surfactant_name SDS
          - -v has_indenter 1
          - -v constant_indenter_velocity -0.000001
          - -v productionSteps 37500000
          - -v pbc2d 0
          - -v reinitialize_velocities 0
          - -v use_colvars 0
          - -v mpiio 1
          - -v thermo_frequency 10000
          - -v thermo_average_frequency 10000
          - -v netcdf_frequency 100000
          - -v restart_frequency 100000
          - -v compute_interactions 1
          - -v store_forces 1
          - -v is_restart 1
          - -v restartFile default.mpiio.restart
          stderr_file:   std.err
          stdout_file:   std.out
          fizzle_bad_rc: true
          use_shell:     true
        _trackers:
        - filename: log.lammps
          nlines: 25

links:
  -1:
  - -2
  -2:
  - -3

metadata:
  - system_name:      646_SDS_on_AU_111_51x30x2_hemicylinders_with_counterion_50Ang_stepped
    surfactant:       SDS
    sf_nmolecules:    646
    sf_preassembly:   hemicylinders
    counterion:       NA
    ci_preassembly:   at polar heads
    substrate:        AU
    sb_name:          AU_111_51x30x2
    sb_crystal_plane: 111
    sb_multiples:
    - 51
    - 30
    - 2
    solvent:          H2O
    sv_density:       997 # kg m^-3
    sv_preassembly:   random
    indenter:         AU
    indenter_pdb:     50Ang_stepped
    indenter_vel:     0.1 # m / s, constant speed, linear translation
    indenter_dist:    7.5 # nm, initial distance above substrate
    temperature:      298 # K
    pressure:         1 # atm
    total_steps:      37500000 # a 2 fs each
    total_time:       75 # ns
